<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vibrance App</title>
    <!-- Use Tailwind CSS for a clean, responsive design -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
        }
        .view-section {
            display: none;
        }
        .view-section.active {
            display: block;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center">

    <!-- Main App Container -->
    <div class="bg-white rounded-xl shadow-lg m-4 w-full max-w-4xl p-6 md:p-8">

        <!-- Header -->
        <header class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800">Vibrance</h1>
            <nav>
                <ul class="flex space-x-4">
                    <li><a href="#" class="nav-link text-gray-600 hover:text-indigo-600 transition-colors" data-view="home">Home</a></li>
                    <li><a href="#" class="nav-link text-gray-600 hover:text-indigo-600 transition-colors" data-view="dashboard">Dashboard</a></li>
                    <li><a href="#" class="nav-link text-gray-600 hover:text-indigo-600 transition-colors" data-view="upload">Upload</a></li>
                </ul>
            </nav>
        </header>

        <!-- User Info and Loader -->
        <div id="user-info" class="text-center text-gray-500 text-sm mb-4">
            <div id="loading" class="flex items-center justify-center p-4">
                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Loading...
            </div>
            <p id="user-id-display" class="hidden">User ID: <span id="user-id"></span></p>
        </div>

        <!-- Dynamic Content Sections -->
        <main>

            <!-- Home View (default) -->
            <section id="home-view" class="view-section active">
                <div class="text-center py-12 px-4 rounded-xl bg-gradient-to-br from-indigo-500 to-purple-600 text-white shadow-xl">
                    <h2 class="text-4xl md:text-5xl font-extrabold mb-2">Find Your Perfect Asset</h2>
                    <p class="text-lg md:text-xl font-light mb-6">Explore a curated collection of unique photos, videos, and sounds.</p>
                    <div class="flex justify-center">
                        <input type="text" placeholder="Search for 'cityscape video' or 'ambient sound'" class="w-full max-w-xl p-3 rounded-full text-gray-800 shadow-md focus:outline-none focus:ring-2 focus:ring-indigo-300">
                    </div>
                </div>

                <!-- Featured Assets Grid -->
                <div id="assets-grid" class="mt-8 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Assets will be dynamically added here -->
                </div>
            </section>

            <!-- Dashboard View -->
            <section id="dashboard-view" class="view-section">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Your Creator Dashboard</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-indigo-50 rounded-lg p-6 text-center shadow-sm">
                        <p class="text-sm text-indigo-600 font-medium">Total Earnings</p>
                        <p class="text-4xl font-bold text-indigo-700 mt-2">$7,543.21</p>
                    </div>
                    <div class="bg-purple-50 rounded-lg p-6 text-center shadow-sm">
                        <p class="text-sm text-purple-600 font-medium">Assets Licensed</p>
                        <p class="text-4xl font-bold text-purple-700 mt-2">1,289</p>
                    </div>
                    <div class="bg-emerald-50 rounded-lg p-6 text-center shadow-sm">
                        <p class="text-sm text-emerald-600 font-medium">Monthly Active</p>
                        <p class="text-4xl font-bold text-emerald-700 mt-2">+$125.50</p>
                    </div>
                </div>
                <h3 class="text-xl font-bold text-gray-800 mb-4">Top Performing Assets</h3>
                <div class="space-y-4">
                    <div class="bg-gray-50 p-4 rounded-lg shadow-sm flex items-center justify-between">
                        <span class="font-medium text-gray-700">Rainy City Street (Video)</span>
                        <span class="text-green-600 font-bold">$2,100</span>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg shadow-sm flex items-center justify-between">
                        <span class="font-medium text-gray-700">Morning Fog in Mountains (Photo)</span>
                        <span class="text-green-600 font-bold">$1,550</span>
                    </div>
                </div>
            </section>

            <!-- Upload View -->
            <section id="upload-view" class="view-section">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Upload New Asset</h2>
                <div class="bg-gray-50 p-8 rounded-xl shadow-md">
                    <div class="mb-4">
                        <label for="asset-name" class="block text-sm font-medium text-gray-700 mb-1">Asset Title</label>
                        <input type="text" id="asset-name" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div class="mb-4">
                        <label for="asset-description" class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                        <textarea id="asset-description" rows="4" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
                    </div>
                    <div class="mb-6">
                        <label for="asset-price" class="block text-sm font-medium text-gray-700 mb-1">Price ($)</label>
                        <input type="number" id="asset-price" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" value="5" min="1">
                    </div>
                    <button id="upload-btn" class="w-full bg-indigo-500 text-white font-semibold py-3 rounded-lg hover:bg-indigo-600 transition-colors">Submit Asset</button>
                    <div id="upload-message" class="mt-4 text-sm text-center font-medium hidden"></div>
                </div>
            </section>
        </main>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, onSnapshot, collection, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- App Initialization and Authentication ---
        let app;
        let auth;
        let db;
        let userId;

        const loadingIndicator = document.getElementById('loading');
        const userIdDisplay = document.getElementById('user-id-display');
        const userIdSpan = document.getElementById('user-id');

        // Function to create an asset card HTML element
        function createAssetCard(assetData) {
            const card = document.createElement('div');
            card.className = "bg-gray-50 rounded-lg shadow-md overflow-hidden transform hover:scale-105 transition-transform duration-300";
            card.innerHTML = `
                <img src="${assetData.imageUrl}" alt="${assetData.title}" class="w-full h-48 object-cover">
                <div class="p-4">
                    <h3 class="font-semibold text-lg text-gray-800">${assetData.title}</h3>
                    <p class="text-sm text-gray-500">${assetData.description}</p>
                    <button class="mt-3 w-full bg-indigo-500 text-white py-2 rounded-md hover:bg-indigo-600 transition-colors">License for $${assetData.price}</button>
                </div>
            `;
            return card;
        }

        // --- Real-time data loading from Firestore ---
        function loadAssets() {
            if (!db || !userId) return;

            const assetsGrid = document.getElementById('assets-grid');
            const assetsCollection = collection(db, `artifacts/${appId}/public/data/assets`);

            // Use onSnapshot to listen for real-time changes
            onSnapshot(assetsCollection, (querySnapshot) => {
                assetsGrid.innerHTML = ''; // Clear the grid
                querySnapshot.forEach((doc) => {
                    const assetData = doc.data();
                    const imageUrl = assetData.imageUrl || `https://placehold.co/600x400/D1D5DB/1F2937?text=${encodeURIComponent(assetData.title)}`;
                    const card = createAssetCard({
                        title: assetData.title,
                        description: assetData.description,
                        price: assetData.price,
                        imageUrl: imageUrl
                    });
                    assetsGrid.appendChild(card);
                });
            }, (error) => {
                console.error("Error fetching assets: ", error);
            });
        }

        // Function to handle asset upload
        async function uploadAsset() {
            if (!db || !userId) {
                console.error("Database not initialized or user not logged in.");
                return;
            }

            const title = document.getElementById('asset-name').value;
            const description = document.getElementById('asset-description').value;
            const price = parseFloat(document.getElementById('asset-price').value);
            const uploadMessage = document.getElementById('upload-message');

            if (!title || !description || isNaN(price) || price <= 0) {
                uploadMessage.textContent = 'Please fill out all fields correctly.';
                uploadMessage.classList.remove('hidden', 'text-green-600', 'text-red-600');
                uploadMessage.classList.add('text-red-600');
                return;
            }

            try {
                const assetsCollection = collection(db, `artifacts/${appId}/public/data/assets`);
                await addDoc(assetsCollection, {
                    title: title,
                    description: description,
                    price: price,
                    createdAt: new Date(),
                    ownerId: userId,
                    imageUrl: `https://placehold.co/600x400/A3E635/1F2937?text=${encodeURIComponent(title)}`
                });

                uploadMessage.textContent = 'Asset submitted successfully!';
                uploadMessage.classList.remove('hidden', 'text-red-600');
                uploadMessage.classList.add('text-green-600');
                document.getElementById('asset-name').value = '';
                document.getElementById('asset-description').value = '';
                document.getElementById('asset-price').value = '5';

            } catch (e) {
                console.error("Error adding document: ", e);
                uploadMessage.textContent = `Error: ${e.message}`;
                uploadMessage.classList.remove('hidden', 'text-green-600');
                uploadMessage.classList.add('text-red-600');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Simple JavaScript to handle view switching
            const navLinks = document.querySelectorAll('.nav-link');
            const viewSections = document.querySelectorAll('.view-section');

            navLinks.forEach(link => {
                link.addEventListener('click', (event) => {
                    event.preventDefault();
                    const targetView = event.target.dataset.view;

                    // Remove 'active' class from all views
                    viewSections.forEach(section => {
                        section.classList.remove('active');
                    });

                    // Add 'active' class to the target view
                    const activeView = document.getElementById(`${targetView}-view`);
                    if (activeView) {
                        activeView.classList.add('active');
                    }
                });
            });

            // Handle asset upload button click
            document.getElementById('upload-btn').addEventListener('click', uploadAsset);

            // Initialize Firebase and set up auth listener
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    userIdSpan.textContent = userId;
                    loadingIndicator.classList.add('hidden');
                    userIdDisplay.classList.remove('hidden');
                    loadAssets(); // Load assets from the database
                } else {
                    // Sign in with custom token or anonymously if token is not available
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Firebase Auth Error: ", error);
                    }
                }
            });
        });
    </script>
</body>
</html>
